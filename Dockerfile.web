# ---- Stage 1: Dependencies ----
FROM node:22-alpine AS deps
RUN corepack enable && corepack prepare pnpm@latest --activate
WORKDIR /app

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/web/package.json apps/web/

RUN pnpm install --frozen-lockfile

# ---- Stage 2: Build ----
FROM deps AS build
ARG NEXT_PUBLIC_API_URL=http://localhost/api
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

COPY apps/web/ apps/web/
COPY tsconfig.base.json ./

RUN pnpm --filter @eduforge/web build

# ---- Stage 3: Production ----
FROM node:22-alpine AS production
WORKDIR /app

ENV NODE_ENV=production

# Copy standalone Next.js output if available, otherwise full build
COPY --from=build /app/apps/web/.next/ apps/web/.next/
COPY --from=build /app/apps/web/public/ apps/web/public/
COPY --from=build /app/apps/web/package.json apps/web/
COPY --from=build /app/apps/web/node_modules/ apps/web/node_modules/
COPY --from=build /app/node_modules/ node_modules/
COPY pnpm-workspace.yaml package.json ./

# Run as non-root user
RUN addgroup -g 1001 -S appgroup && adduser -S appuser -u 1001 -G appgroup
RUN chown -R appuser:appgroup /app
USER appuser

EXPOSE 3000
WORKDIR /app/apps/web
CMD ["npx", "next", "start"]
