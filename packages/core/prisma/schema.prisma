generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== 用户 =====

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id           String     @id @default(cuid())
  email        String?    @unique
  phone        String?    @unique
  name         String
  passwordHash String
  role         UserRole   @default(STUDENT)
  status       UserStatus @default(ACTIVE)
  avatarUrl    String?
  schoolId     String?
  school       School?    @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  teacherProfile Teacher?
  studentProfile Student?
  aiUsageLogs    AIUsageLog[]

  @@index([schoolId])
  @@index([role])
}

model Teacher {
  id        String         @id @default(cuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?
  createdAt DateTime       @default(now())
  classes   ClassTeacher[]

  @@index([userId])
}

model Student {
  id        String         @id @default(cuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentNo String?
  createdAt DateTime       @default(now())
  classes   ClassStudent[]

  @@index([userId])
}

// ===== 组织结构 =====

model School {
  id        String     @id @default(cuid())
  name      String
  code      String     @unique
  address   String?
  phone     String?
  logo      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  users     User[]
  grades    Grade[]
  aiConfigs AIConfig[]
}

model StudyLevel {
  id    String @id @default(cuid())
  code  String @unique
  name  String
  order Int

  grades Grade[]
}

model Grade {
  id           String     @id @default(cuid())
  name         String
  code         String     @unique
  order        Int
  studyLevelId String
  studyLevel   StudyLevel @relation(fields: [studyLevelId], references: [id], onDelete: Cascade)
  schoolId     String?
  school       School?    @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  createdAt    DateTime   @default(now())

  classes Class[]

  @@index([studyLevelId])
  @@index([schoolId])
}

model Class {
  id           String   @id @default(cuid())
  name         String
  gradeId      String
  grade        Grade    @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  academicYear String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  teachers ClassTeacher[]
  students ClassStudent[]

  @@index([gradeId])
}

model Subject {
  id    String @id @default(cuid())
  name  String
  code  String @unique
  color String?
  icon  String?
  order Int    @default(0)

  classTeachers ClassTeacher[]

  @@index([code])
}

model ClassTeacher {
  classId   String
  cls       Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@id([classId, teacherId, subjectId])
}

model ClassStudent {
  classId   String
  cls       Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@id([classId, studentId])
}

// ===== 插件管理 =====

enum PluginStatus {
  ACTIVE
  DISABLED
  ERROR
}

model Plugin {
  id          String       @id @default(cuid())
  name        String       @unique
  version     String
  displayName String?
  description String?
  status      PluginStatus @default(ACTIVE)
  config      Json?
  installedAt DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([status])
}

// ===== AI 配置 =====

model AIConfig {
  id        String   @id @default(cuid())
  schoolId  String?
  school    School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  provider  String
  model     String
  apiKey    String
  baseUrl   String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model AIUsageLog {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schoolId     String?
  plugin       String
  provider     String
  model        String
  inputTokens  Int
  outputTokens Int
  cost         Float?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([schoolId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// ===== 系统设置 =====

model Setting {
  key   String @id
  value Json
  scope String @default("system")

  @@index([scope])
}
